<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartMeet UNZA - User Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg">
    <link rel="alternate icon" type="image/png" sizes="256x256" href="../assets/images/favicon-256.png">
    <meta name="theme-color" content="#1e40af">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
        .status-pending { color: #f59e0b; }
        .status-approved { color: #10b981; }
        .status-rejected { color: #ef4444; }
        .status-completed { color: #3b82f6; }
        .venue-booked { opacity: 0.6; pointer-events: none; }
    .user-sidebar-bg { background-color: #f3f4f6; }
    @media (min-width: 768px) {
      .user-sidebar-bg { background-image: linear-gradient(to right, #1e40af 0, #1e40af 16rem, #f3f4f6 16rem, #f3f4f6 100%); }
    }
    /* Smooth page fade */
      body.page-fade{opacity:0}
      body.page-fade.page-fade-in{opacity:1;transition:opacity .18s ease}
      body.page-fade.is-leaving{opacity:0}
      /* Speed up rendering for large sections */
      .cv{ content-visibility:auto; contain-intrinsic-size: 1px 500px; }
    </style>
</head>
<body class="bg-gray-100 user-sidebar-bg">
    <div class="flex min-h-screen items-stretch">
        <!-- Sidebar -->
        <div id="sidebar-container" class="h-full"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Navigation -->
            <div id="header-container"></div>
        
            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Quick Actions -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Dashboard</h2>
                </div>

                <!-- Title Picture -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg shadow p-5 mb-6 flex items-center gap-4 text-white">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-md">
                        <span class="text-blue-800 font-bold text-xl">UNZA</span>
                    </div>
                    <div>
                        <p class="text-sm opacity-90">Welcome to</p>
                        <p class="text-xl font-semibold">SmartMeet User Dashboard</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Upcoming Meetings Card -->
                    <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition-shadow border-l-4 border-blue-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Upcoming Meetings</p>
                                <p class="text-2xl font-bold text-gray-800"><span id="statUpcoming">—</span></p>
                            </div>
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span id="statUpcomingDelta" class="text-green-600 text-sm font-medium"></span>
                        </div>
                    </div>

                    <!-- Documents Card -->
                    <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition-shadow border-l-4 border-green-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Documents</p>
                                <p class="text-2xl font-bold text-gray-800"><span id="statDocuments">—</span></p>
                            </div>
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-file-alt"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span id="statDocumentsDelta" class="text-green-600 text-sm font-medium"></span>
                        </div>
                    </div>

                    <!-- Notifications Card -->
                    <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition-shadow border-l-4 border-yellow-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Unread Notifications</p>
                                <p class="text-2xl font-bold text-gray-800"><span id="statUnread">—</span></p>
                            </div>
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-bell"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="notifications.html" class="text-blue-600 hover:underline text-sm font-medium">View all</a>
                        </div>
                    </div>

                    <!-- Quick Actions Card -->
                    <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition-shadow border-l-4 border-purple-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Quick Actions</p>
                                <p class="text-2xl font-bold text-gray-800"><span id="statQuick">—</span></p>
                            </div>
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-bolt"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="text-blue-600 hover:underline text-sm font-medium">View actions</button>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Meetings Section -->
                <div class="bg-white rounded-lg shadow overflow-hidden mb-8 cv">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Upcoming Meetings</h3>
                            <a href="my-meetings.html" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View All</a>
                        </div>
                    </div>
                    <div id="dashboardUpcomingList" class="divide-y divide-gray-200"></div>
                </div>

                <!-- Recent Activity -->
                
                
                <!-- Recent Documents -->
                <div class="bg-white rounded-lg shadow overflow-hidden cv">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold">Recent Documents</h3>
                        </div>
                        <div class="p-6 text-gray-500" id="recentDocumentsEmpty">No documents available</div>
                    </div>

                    <!-- Recent Notifications -->
                    <div class="bg-white rounded-lg shadow overflow-hidden cv">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold">Recent Notifications</h3>
                        </div>
                        <div class="p-6 text-gray-500" id="recentNotificationsEmpty">No notifications</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    
    <script>
        
    (function(){
    async function fetchJSON(url){ const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''; const headers = token ? { 'Authorization': 'Bearer ' + token } : {}; const r = await fetch(url,{ headers }); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    function formatRange(sISO,eISO){ const s=new Date(sISO), e=new Date(eISO); const time=d=>d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); return `${s.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'})}, ${time(s)} - ${time(e)}`; }
    function canJoin(m){ const now=new Date(); const s=new Date(m.start), e=new Date(m.end); return now>=new Date(s.getTime()-15*60*1000)&& now<=e; }
    function showToast(msg,type='success'){ const t=document.getElementById('toast'); const m=document.getElementById('toast-message')||document.getElementById('toastMessage'); if(t&&m){ m.textContent=msg; t.className=`fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 flex items-center ${type==='success'?'bg-green-500':'bg-red-500'} text-white`; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2000); } }
    function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }

    async function loadDashboard(){
      try {
        const data = await fetchJSON('/api/user/dashboard');
        setText('statUpcoming', data.upcomingCount ?? '—');
        setText('statDocuments', data.documentsCount ?? '—');
        setText('statUnread', data.unreadNotificationsCount ?? '—');
        setText('statQuick', data.quickActionsCount ?? '—');
        if (data.upcomingDelta !== undefined) setText('statUpcomingDelta', data.upcomingDelta);
        if (data.documentsDelta !== undefined) setText('statDocumentsDelta', data.documentsDelta);
      } catch(e){ /* keep placeholders */ }
    }

    async function loadUpcoming(){
      const box = document.getElementById('dashboardUpcomingList');
      if (!box) return;
      try {
        const items = await fetchJSON('/api/user/meetings?upcoming=true&limit=3');
        if (!Array.isArray(items) || items.length===0){ box.innerHTML = `<div class="p-6 text-gray-500">No upcoming meetings</div>`; return; }
        box.innerHTML = items.map(m=>{
          const isVirtual = !!m.link;
          const joinable = isVirtual && canJoin(m);
          return `
            <div class="p-6 hover:bg-gray-50">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-12 w-12 rounded-full ${m.createdBy&&m.createdBy!=='user' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center">
                  <i class="fas ${isVirtual ? 'fa-video' : 'fa-users'}"></i>
                </div>
                <div class="ml-4">
                  <h4 class="text-md font-medium text-gray-900">${m.title||''}</h4>
                  <div class="flex items-center text-sm text-gray-500 mt-1">
                    <span class="flex items-center"><i class="far fa-clock mr-1"></i> ${formatRange(m.start,m.end)}</span>
                    <span class="mx-2">•</span>
                    <span class="flex items-center"><i class="fas ${isVirtual ? 'fa-video' : 'fa-map-marker-alt'} mr-1"></i> ${m.location || (isVirtual ? 'Online' : '')}</span>
                  </div>
                </div>
                <div class="ml-auto">
                  ${isVirtual ? `<button data-id="${m.id}" class="dash-join px-4 py-2 ${joinable ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gray-200 text-gray-500 cursor-not-allowed'} text-sm font-medium rounded-md focus:outline-none">Join</button>` : ''}
                </div>
              </div>
            </div>`;
        }).join('');
        document.querySelectorAll('.dash-join').forEach(btn=>{
          btn.addEventListener('click',(e)=>{
            const id=e.currentTarget.getAttribute('data-id');
            const m=items.find(x=>String(x.id)===String(id));
            if(!m||!m.link) return;
            if(canJoin(m)) window.open(m.link,'_blank'); else showToast('Meeting not joinable yet','error');
          });
        });
      } catch(e){
        box.innerHTML = `<div class="p-6 text-gray-500">No upcoming meetings</div>`;
      }
    }

    // Load all data
    async function loadAllData() {
      try {
        await Promise.all([
          loadDashboard(),
          loadUpcoming()
        ]);
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showToast('Failed to load dashboard data', 'error');
      }
    }

    // Load user's meetings
    async function loadUserMeetings() {
      try {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
        const response = await fetch('/api/user/meetings', { headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
        if (!response.ok) throw new Error('Failed to load meetings');
        const meetings = await response.json();
        
        const tbody = document.getElementById('meetingsList');
        if (!meetings || meetings.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                No meetings found. <button id="newMeetingEmptyBtn" class="text-blue-600 hover:underline">Create one now</button>
              </td>
            </tr>`;
          document.getElementById('newMeetingEmptyBtn')?.addEventListener('click', () => {
            document.getElementById('newMeetingBtn').click();
          });
          return;
        }
        
        tbody.innerHTML = meetings.map(meeting => `
          <tr class="${meeting.status === 'rejected' ? 'bg-red-50' : ''}">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${escapeHtml(meeting.title)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${escapeHtml(meeting.venue)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${formatDate(meeting.date)}</div>
              <div class="text-xs text-gray-500">${meeting.startTime} - ${meeting.endTime}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                ${getStatusClass(meeting.status)}">
                ${meeting.status.charAt(0).toUpperCase() + meeting.status.slice(1)}
              </span>
              ${meeting.status === 'rejected' && meeting.reason ? 
                `<div class="text-xs text-gray-500 mt-1">${escapeHtml(meeting.reason)}</div>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              ${meeting.status === 'pending' ? `
                <button class="text-red-600 hover:text-red-900 mr-3 cancel-meeting" data-id="${meeting.id}">
                  <i class="fas fa-times"></i> Cancel
                </button>` : ''}
              ${meeting.status === 'approved' ? `
                <a href="${meeting.meetLink || '#'}" target="_blank" class="text-blue-600 hover:text-blue-900">
                  <i class="fas fa-video"></i> Join
                </a>` : ''}
            </td>
          </tr>
        `).join('');

        // Add event listeners for cancel buttons
        document.querySelectorAll('.cancel-meeting').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const meetingId = e.currentTarget.dataset.id;
            if (confirm('Are you sure you want to cancel this meeting request?')) {
              cancelMeeting(meetingId);
            }
          });
        });
      } catch (error) {
        console.error('Error loading meetings:', error);
        showToast('Failed to load meetings', 'error');
      }
    }

    // Load available venues
    async function loadAvailableVenues() {
      try {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
        const response = await fetch('/api/venues', { headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
        if (!response.ok) throw new Error('Failed to load venues');
        const venues = await response.json();
        
        const venuesList = document.getElementById('venuesList');
        if (!venues || venues.length === 0) {
          venuesList.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-4">No venues available at the moment</div>';
          return;
        }
        
        venuesList.innerHTML = venues.map(venue => `
          <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${venue.status === 'booked' ? 'venue-booked' : ''}">
            <div class="font-semibold text-lg mb-1">${escapeHtml(venue.name)}</div>
            <div class="text-sm text-gray-600 mb-2">
              <i class="fas fa-map-marker-alt mr-1"></i> ${escapeHtml(venue.location)}
            </div>
            <div class="text-sm text-gray-600 mb-3">
              <i class="fas fa-users mr-1"></i> Capacity: ${venue.capacity} people
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs px-2 py-1 rounded-full ${venue.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                ${venue.status === 'available' ? 'Available' : 'Booked'}
              </span>
              <button class="text-blue-600 text-sm hover:underline book-venue" 
                      data-venue-id="${venue.id}" 
                      data-venue-name="${escapeHtml(venue.name)}"
                      ${venue.status === 'booked' ? 'disabled' : ''}>
                Book Now
              </button>
            </div>
          </div>
        `).join('');

        // Add event listeners for book buttons
        document.querySelectorAll('.book-venue:not([disabled])').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const venueId = e.currentTarget.dataset.venueId;
            const venueName = e.currentTarget.dataset.venueName;
            openNewMeetingModal(venueId, venueName);
          });
        });
      } catch (error) {
        console.error('Error loading venues:', error);
        showToast('Failed to load venues', 'error');
      }
    }

    // Open new meeting modal
    function openNewMeetingModal(venueId = '', venueName = '') {
      const modal = document.getElementById('newMeetingModal');
      const venueSelect = document.getElementById('venueSelect');
      
      // If venue is pre-selected
      if (venueId && venueName) {
        venueSelect.innerHTML = `<option value="${venueId}" selected>${escapeHtml(venueName)}</option>`;
      } else {
        // Otherwise load all venues
        fetch('/api/venues', { headers: (function(){ const t = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''; return t ? { 'Authorization': 'Bearer ' + t } : {}; })() })
          .then(res => res.json())
          .then(venues => {
            venueSelect.innerHTML = '<option value="">Select a venue</option>' +
              venues.map(v => `<option value="${v.id}">${escapeHtml(v.name)} (${v.capacity} people)</option>`).join('');
            
            if (venueId) {
              venueSelect.value = venueId;
            }
          });
      }
      
      // Reset form
      document.getElementById('meetingRequestForm').reset();
      
      // Show modal
      modal.classList.remove('hidden');
      
      // Set focus on first input
      document.getElementById('meetingTitle').focus();
    }

    // Close modal
    function closeModal() {
      document.getElementById('newMeetingModal').classList.add('hidden');
    }

    // Format date for display
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }

    // Get status class for styling
    function getStatusClass(status) {
      const classes = {
        pending: 'bg-yellow-100 text-yellow-800',
        approved: 'bg-green-100 text-green-800',
        rejected: 'bg-red-100 text-red-800',
        completed: 'bg-blue-100 text-blue-800'
      };
      return classes[status] || 'bg-gray-100 text-gray-800';
    }

    // Cancel a meeting
    async function cancelMeeting(meetingId) {
      try {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
        const response = await fetch(`/api/meetings/${meetingId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': 'Bearer ' + token } : {}) },
          body: JSON.stringify({ reason: 'Cancelled by user' })
        });
        
        if (!response.ok) throw new Error('Failed to cancel meeting');
        
        showToast('Meeting request cancelled', 'success');
        loadUserMeetings();
      } catch (error) {
        console.error('Error cancelling meeting:', error);
        showToast('Failed to cancel meeting', 'error');
      }
    }

    // Initialize event listeners
    function initEventListeners() {
      // New meeting button
      document.getElementById('newMeetingBtn')?.addEventListener('click', () => openNewMeetingModal());
      
      // Close modal buttons
      document.getElementById('closeModal')?.addEventListener('click', closeModal);
      document.getElementById('cancelMeeting')?.addEventListener('click', closeModal);
      
      // Click outside modal to close
      document.getElementById('newMeetingModal')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('newMeetingModal')) {
          closeModal();
        }
      });
      
      // Refresh meetings
      document.getElementById('refreshMeetings')?.addEventListener('click', loadUserMeetings);
      
      // Form submission
      const meetingForm = document.getElementById('meetingRequestForm');
      if (meetingForm) {
        meetingForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = {
            title: document.getElementById('meetingTitle').value.trim(),
            date: document.getElementById('meetingDate').value,
            startTime: document.getElementById('startTime').value,
            endTime: document.getElementById('endTime').value,
            venueId: document.getElementById('venueSelect').value,
            description: document.getElementById('meetingDescription').value.trim()
          };
          
          if (!formData.title || !formData.date || !formData.startTime || !formData.endTime || !formData.venueId) {
            showToast('Please fill in all required fields', 'error');
            return;
          }
          
          try {
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
            // Map form data to backend API contract
            const toDateTime = (d, t) => `${d} ${t}:00`;
            const meetingData = {
              title: formData.title,
              description: formData.description,
              venue_id: formData.venueId || null,
              meeting_type: 'in_person',
              start_time: toDateTime(formData.date, formData.startTime),
              end_time: toDateTime(formData.date, formData.endTime),
              is_recurring: false,
              recurrence_pattern: null,
              max_participants: null
            };

            const response = await fetch('/api/meetings', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': 'Bearer ' + token } : {}) },
              body: JSON.stringify(meetingData)
            });
            
            if (!response.ok) {
              const error = await response.json().catch(()=>({}));
              throw new Error(error.error || error.message || 'Failed to create meeting');
            }
            
            showToast('Meeting created successfully', 'success');
            closeModal();
            loadUserMeetings();
            loadAvailableVenues();
          } catch (error) {
            console.error('Error submitting meeting request:', error);
            showToast(error.message || 'Failed to submit meeting request', 'error');
          }
        });
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      const schedule = window.requestIdleCallback || function(cb){ setTimeout(cb, 0); };
      schedule(async () => {
        await loadAllData();
        // Check for unread notifications
        checkUnreadNotifications();
        // Set up notification polling (check every 30 seconds)
        setInterval(checkUnreadNotifications, 30000);
      });
    });
    
    // Check for unread notifications
    async function checkUnreadNotifications() {
      try {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
        const response = await fetch('/api/notifications/unread/count', { headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
        if (response.ok) {
          const { count } = await response.json();
          const badge = document.querySelector('.notification-badge');
          if (badge) {
            badge.textContent = count > 0 ? (count > 9 ? '9+' : count) : '';
            badge.classList.toggle('hidden', count === 0);
          }
        }
      } catch (error) {
        console.error('Error checking notifications:', error);
      }
    }
    
    // Simple HTML escape function
    function escapeHtml(unsafe) {
      return unsafe
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  })();
    </script>
    <script src="js/common.js"></script>
    <script>
    (function(){
      function sameOrigin(href){ try{ var u=new URL(href, window.location.href); return u.origin===window.location.origin; }catch(e){ return false; } }
      function isAnchorLink(a){ var href=a.getAttribute('href')||''; return href.startsWith('#'); }
      function onReady(fn){ if (document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(fn,0); } else { document.addEventListener('DOMContentLoaded', fn); } }
      // Fade-in on load
      onReady(function(){
        document.body.classList.add('page-fade');
        requestAnimationFrame(function(){ document.body.classList.add('page-fade-in'); });
      });
      // Smooth fade-out navigation and prefetch
      document.addEventListener('click', function(e){
        var a = e.target.closest('a[href]');
        if(!a) return;
        if (a.target && a.target !== '' && a.target !== '_self') return;
        if (a.hasAttribute('download')) return;
        var href = a.getAttribute('href');
        if (!href || isAnchorLink(a) || !sameOrigin(href)) return;
        if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
        e.preventDefault();
        document.body.classList.add('is-leaving');
        setTimeout(function(){ window.location.href = href; }, 180);
      });
      var prefetched=new Set();
      function prefetch(href){
        try {
          if (prefetched.has(href)) return;
          var l=document.createElement('link'); l.rel='prefetch'; l.href=href; document.head.appendChild(l);
          prefetched.add(href);
        } catch(e){}
      }
      document.addEventListener('mouseover', function(e){ var a=e.target.closest('a[href]'); if(!a) return; var href=a.getAttribute('href')||''; if(sameOrigin(href) && !isAnchorLink(a)) prefetch(href); });
      document.addEventListener('touchstart', function(e){ var a=e.target.closest('a[href]'); if(!a) return; var href=a.getAttribute('href')||''; if(sameOrigin(href) && !isAnchorLink(a)) prefetch(href); }, {passive:true});
    })();
    </script>
</body>
</html>
