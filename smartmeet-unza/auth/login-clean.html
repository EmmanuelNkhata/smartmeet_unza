<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SmartMeet UNZA</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg">
    <link rel="alternate icon" type="image/png" sizes="256x256" href="../assets/images/favicon-256.png">
    <meta name="theme-color" content="#1e40af">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../public/css/tailwind.css">
    <link rel="stylesheet" href="../public/css/base.css">
    <link rel="stylesheet" href="../public/css/styles.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #cfe9ff 0%, #93c5fd 30%, #60a5fa 55%, #3b82f6 75%, #1e40af 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; position: relative; z-index: 1; }
        .login-box { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,.1); width: 100%; max-width: 420px; }
        .input-field { position: relative; margin-bottom: 1rem; }
        .input-field input { width: 100%; padding: 12px 16px 12px 40px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; transition: all .3s; }
        .input-field input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79,70,229,.2); }
        .input-field i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .btn-primary { background-color: #4f46e5; color: white; padding: 12px; border-radius: 6px; font-weight: 500; width: 100%; transition: background-color .3s; }
        .btn-primary:hover { background-color: #4338ca; }
        .hidden { display: none; }
        .error-message { color: #ef4444; font-size: .875rem; margin-top: .5rem; display: none; }
    </style>
</head>
<body>
<div class="login-container">
  <div class="login-box p-8 w-full max-w-md mx-4 bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl">
    <!-- Logo -->
    <div class="text-center mb-6">
      <img id="brandLogo" src="../assets/images/20250308_013030.jpg" alt="SmartMeet UNZA Logo" class="mx-auto mb-4 h-16 object-contain" onerror="this.style.display='none';document.getElementById('fallbackLogo').classList.remove('hidden');">
      <div id="fallbackLogo" class="hidden">
        <h1 class="text-2xl font-bold text-gray-800">SmartMeet</h1>
        <p class="text-indigo-600 font-medium">UNZA</p>
      </div>
    </div>

    <!-- Single global error box -->
    <div id="globalError" class="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 mb-4 hidden" role="alert">
      <p id="globalErrorText"></p>
    </div>

    <!-- Welcome Section -->
    <div id="welcomeSection" class="text-center">
      <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Welcome to SmartMeet UNZA</h1>
        <p class="text-gray-500 text-sm mb-6">Please select your login method</p>
        <div class="space-y-4 mb-6">
          <button id="adminLoginBtn" type="button" class="w-full text-left border rounded-lg p-4 hover:bg-gray-50 transition-colors" aria-label="Admin Login">
            <h3 class="font-semibold text-gray-800">Admin Login</h3>
            <p class="text-sm text-gray-500">Access admin dashboard and user management</p>
          </button>
          <button id="userLoginBtn" type="button" class="w-full text-left border rounded-lg p-4 hover:bg-gray-50 transition-colors" aria-label="User Login">
            <h3 class="font-semibold text-gray-800">User Login</h3>
            <p class="text-sm text-gray-500">Access your user account</p>
          </button>
        </div>
        <div class="relative my-6">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
          <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or</span></div>
        </div>
        <p class="text-sm text-gray-600">First time here? <a href="#" id="showSignup1" data-action="show-signup" class="text-indigo-600 font-medium hover:underline">Setup Admin Account</a></p>
      </div>
    </div>

    <!-- Admin Signup Form -->
    <div id="signupFormContainer" class="hidden">
      <div class="flex items-center mb-4">
        <button id="backToWelcome" class="flex items-center text-indigo-600 hover:text-indigo-800 transition-colors">
          <i class="fas fa-arrow-left mr-2"></i>
          <span class="text-sm font-medium">Back</span>
        </button>
      </div>
      <div class="text-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800 mb-1">Create Admin Account</h1>
        <p class="text-gray-500 text-sm">Set up your admin account to get started</p>
      </div>
      <form id="signupForm" class="mb-2">
        <div class="mt-4" id="googleSignInContainer">
          <div id="g_id_onload"
            data-client_id="<%= process.env.GOOGLE_CLIENT_ID || 'YOUR_GOOGLE_CLIENT_ID' %>"
            data-login_uri="/api/auth/google/callback"
            data-auto_prompt="false"
            data-callback="handleGoogleSignIn">
          </div>
          <div class="g_id_signin"
            data-type="standard"
            data-size="large"
            data-theme="outline"
            data-text="sign_in_with"
            data-shape="rectangular"
            data-logo_alignment="left">
          </div>
        </div>
        <div class="input-field">
          <i class="fas fa-user"></i>
          <input type="text" id="signupName" placeholder="Full Name" autocomplete="name" required>
        </div>
        <div class="input-field">
          <i class="fas fa-envelope"></i>
          <input type="email" id="signupEmail" placeholder="Email (use Gmail)" autocomplete="email" required>
        </div>
        <div class="input-field">
          <i class="fas fa-lock"></i>
          <input type="password" id="signupPassword" placeholder="Create a strong password" minlength="8" required>
        </div>
        <div class="input-field">
          <i class="fas fa-lock"></i>
          <input type="password" id="signupConfirmPassword" placeholder="Confirm password" minlength="8" required>
        </div>
        <button type="submit" id="signupBtn" class="btn-primary"><span>Create Account</span></button>
      </form>
    </div>

    <!-- Login Form -->
    <div id="loginFormContainer" class="hidden">
      <div class="flex items-center mb-4">
        <button id="backToRoles" class="flex items-center text-indigo-600 hover:text-indigo-800 transition-colors">
          <i class="fas fa-arrow-left mr-2"></i>
          <span class="text-sm font-medium">Change Role</span>
        </button>
        <div class="ml-auto bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full flex items-center">
          <span>Logging in as:</span>
          <span id="currentRoleBadge" class="ml-1 font-semibold">User</span>
        </div>
      </div>
      <div class="text-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800 mb-1">Sign In</h1>
        <p class="text-gray-500 text-sm">Sign in to your <span id="selectedRoleText">User</span> account</p>
      </div>
      <form id="loginForm" class="mb-2">
        <div class="input-field">
          <i class="fas fa-envelope"></i>
          <input type="email" id="email" placeholder="Email" autocomplete="username" required>
        </div>
        <div class="input-field">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Password" autocomplete="current-password" required>
        </div>
        <div class="flex items-center justify-between mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="loginRememberMe" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            <span class="ml-2 text-sm text-gray-600">Remember me</span>
          </label>
          <a href="forgot-password.html" class="text-sm text-indigo-600 hover:underline">Forgot password?</a>
        </div>
        <button type="submit" id="loginBtn" class="btn-primary"><span>Sign In</span></button>
      </form>
      <div class="text-center text-sm text-gray-600">Don't have an account? <a href="#" id="showSignup2" class="text-indigo-600 font-medium hover:underline">Sign up</a></div>
    </div>
  </div>
</div>

<script>
  let currentUser = null;
  let currentRole = 'user'; // 'admin' | 'user'

  // Utilities
  function qs(id) { return document.getElementById(id); }
  function showSection(sectionId) {
    ['welcomeSection','loginFormContainer','signupFormContainer'].forEach(id => {
      const el = qs(id);
      if (el) el.classList.toggle('hidden', id !== sectionId);
    });
  }
  function showError(message) {
    const box = qs('globalError');
    const text = qs('globalErrorText');
    if (!box || !text) return;
    text.textContent = message || 'An unexpected error occurred';
    box.classList.remove('hidden');
    setTimeout(() => box.classList.add('hidden'), 5000);
  }

  async function checkAdminExists() {
    try {
      const res = await fetch('/api/users/check-admin');
      if (!res.ok) throw new Error('Failed to check admin status');
      const data = await res.json();
      return !!data.exists;
    } catch (e) {
      console.warn('checkAdminExists failed, assuming admin exists to avoid duplicate signups:', e);
      return true;
    }
  }

  async function verifySession() {
    const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
    if (!token) return false;
    try {
      const res = await fetch('/api/auth/verify', { headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) return false;
      const user = await res.json();
      currentUser = user;
      const isAdmin = user && (user.role === 'admin');
      window.location.href = isAdmin ? '/admin/index.html' : '/user-ui/index.html';
      return true;
    } catch (e) {
      console.warn('verifySession error:', e);
      localStorage.removeItem('authToken');
      sessionStorage.removeItem('authToken');
      return false;
    }
  }

  // Validate email format
  function isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(email).toLowerCase());
  }

  // Validate password strength
  function isStrongPassword(password) {
    // At least 8 characters, 1 uppercase, 1 lowercase, 1 number
    const re = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
    return re.test(password);
  }

  // Show loading state on a button
  function setLoading(button, isLoading) {
    if (!button) return;
    
    if (isLoading) {
      button.disabled = true;
      const originalText = button.querySelector('span')?.textContent || button.textContent;
      button.setAttribute('data-original-text', originalText);
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
    } else {
      button.disabled = false;
      const originalText = button.getAttribute('data-original-text');
      if (originalText) {
        button.innerHTML = `<span>${originalText}</span>`;
      }
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    
    const email = qs('email')?.value.trim() || '';
    const password = qs('password')?.value || '';
    const rememberMe = qs('loginRememberMe')?.checked || false;
    const loginBtn = qs('loginBtn');
    
    // Clear previous errors
    showError('');
    
    // Validate inputs
    if (!email) return showError('Please enter your email');
    if (!isValidEmail(email)) return showError('Please enter a valid email address');
    if (!password) return showError('Please enter your password');
    
    setLoading(loginBtn, true);

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, role: currentRole })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || 'Login failed');
      }
      const { token, user } = await res.json();
      if (rememberMe) localStorage.setItem('authToken', token); else sessionStorage.setItem('authToken', token);
      currentUser = user;
      window.location.href = user && user.role === 'admin' ? '/admin/index.html' : '/user-ui/index.html';
    } catch (err) {
      console.error('Login error:', err);
      showError(err.message || 'Failed to login. Please check your credentials and try again.');
    } finally {
      setLoading(loginBtn, false);
    }
  }

  async function handleSignup(e) {
    e.preventDefault();
    const signupBtn = qs('signupBtn');
    const name = qs('signupName')?.value.trim() || '';
    const email = qs('signupEmail')?.value.trim() || '';
    const password = qs('signupPassword')?.value || '';
    const confirm = qs('signupConfirmPassword')?.value || '';

    // Clear previous errors
    showError('');

    // Validate inputs
    if (!name) return showError('Please enter your full name');
    if (!email) return showError('Please enter your email');
    if (!isValidEmail(email)) return showError('Please enter a valid email address');
    if (!email.endsWith('@gmail.com')) return showError('Please use a Gmail address for admin signup');
    if (!password) return showError('Please enter a password');
    if (!isStrongPassword(password)) {
      return showError('Password must be at least 8 characters long and include uppercase, lowercase, and numbers');
    }
    if (password !== confirm) return showError('Passwords do not match');

    setLoading(signupBtn, true);

    try {
      const exists = await checkAdminExists();
      if (exists) throw new Error('An admin account already exists');

      const res = await fetch('/api/users', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password, role: 'admin', isFirstLogin: true })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || 'Failed to create admin account');
      }

      // Auto-login after successful signup
      const loginRes = await fetch('/api/auth/login', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, role: 'admin' })
      });
      if (!loginRes.ok) throw new Error('Failed to login after signup');
      const { token, user } = await loginRes.json();
      localStorage.setItem('authToken', token);
      currentUser = user;
      window.location.href = '/admin/index.html';
    } catch (err) {
      console.error('Signup error:', err);
      showError(err.message || 'Failed to create account. Please try again.');
    } finally {
      setLoading(signupBtn, false);
    }
  }

  function setupEventListeners() {
    const adminBtn = qs('adminLoginBtn');
    const userBtn = qs('userLoginBtn');
    const showSignup1 = qs('showSignup1');
    const showSignup2 = qs('showSignup2');
    const backToWelcome = qs('backToWelcome');
    const backToRoles = qs('backToRoles');

    adminBtn && (adminBtn.onclick = (e) => {
      e.preventDefault();
      currentRole = 'admin';
      const badge = qs('currentRoleBadge'); const txt = qs('selectedRoleText');
      if (badge) badge.textContent = 'Admin';
      if (txt) txt.textContent = 'Admin';
      showSection('loginFormContainer');
    });

    userBtn && (userBtn.onclick = (e) => {
      e.preventDefault();
      currentRole = 'user';
      const badge = qs('currentRoleBadge'); const txt = qs('selectedRoleText');
      if (badge) badge.textContent = 'User';
      if (txt) txt.textContent = 'User';
      showSection('loginFormContainer');
    });

    showSignup1 && (showSignup1.onclick = (e) => { e.preventDefault(); showSection('signupFormContainer'); });
    showSignup2 && (showSignup2.onclick = (e) => { e.preventDefault(); showSection('signupFormContainer'); });
    backToWelcome && (backToWelcome.onclick = (e) => { e.preventDefault(); showSection('welcomeSection'); });
    backToRoles && (backToRoles.onclick = (e) => { e.preventDefault(); showSection('welcomeSection'); });

    const loginForm = qs('loginForm');
    loginForm && loginForm.addEventListener('submit', handleLogin);
    const signupForm = qs('signupForm');
    signupForm && signupForm.addEventListener('submit', handleSignup);
  }

  // Handle Google Sign-In response
  function handleGoogleSignIn(response) {
    try {
      // Decode the JWT token
      const responsePayload = JSON.parse(atob(response.credential.split('.')[1]));
      console.log('Google Sign-In successful:', responsePayload);
      
      // Handle the Google sign-in response here
      // You can extract user info from responsePayload and process it
      // Example: const { email, name, picture } = responsePayload;
      
      // For now, just show a success message
      showError('Google Sign-In successful! Please use the form to complete your admin setup.');
    } catch (error) {
      console.error('Google Sign-In error:', error);
      showError('Failed to process Google Sign-In. Please try again.');
    }
  }

  // Initialize Google Sign-In
  function initGoogleSignIn() {
    if (typeof google === 'undefined' || !google.accounts) {
      console.warn('Google Sign-In client library not loaded');
      return;
    }
    const clientId = document.getElementById('g_id_onload')?.getAttribute('data-client_id') || '';
    if (!clientId || clientId === 'YOUR_GOOGLE_CLIENT_ID') {
      console.warn('Google Client ID not configured');
      document.getElementById('googleSignInContainer')?.classList.add('hidden');
      return;
    }
    google.accounts.id.initialize({
      client_id: clientId,
      callback: handleGoogleSignIn
    });
  }

  // Initialize the application
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Clear auth data if redirected from logout
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('logout')) {
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('authToken');
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Initialize Google Sign-In
      initGoogleSignIn();
      
      // Check if user is already authenticated
      const isAuthenticated = await verifySession();
      if (isAuthenticated) {
        return; // User is already logged in and will be redirected
      }

      // Setup UI
      setupEventListeners();

      // Show appropriate section based on admin existence
      const adminExists = await checkAdminExists();
      if (!adminExists) {
        showSection('signupFormContainer');
      } else {
        showSection('welcomeSection');
      }
    } catch (e) {
      console.error('Initialization error:', e);
      showError('Failed to initialize application. Please refresh the page.');
    }
  });
</script>
</body>
</html>
